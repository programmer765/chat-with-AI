let recognition = null;
// initializes text to speech api
let speech = new SpeechSynthesisUtterance();
speech.lang = "en";

function initializeSpeechRecognition() {
  // initializes the speech recognition api
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";

  recognition.onstart = function () {
    toggleButton.classList.add("active");
    toggleButton.disabled = true;
    toggleButton.textContent = "Listening...";
  };

  recognition.onresult = function (event) {
    // gets the text generated by speech recognition
    const result = event.results[0][0].transcript;
    // displays the result
    document.getElementById("result_user").textContent = result;
    // styles button for the current session
    toggleButton.classList.remove("active");
    toggleButton.disabled = false;
    toggleButton.textContent = "Press Me";
    // generates the result from GPT
    getReplyFromAI(result);
  };

  recognition.onerror = function (event) {
    toggleButton.classList.remove("active");
    toggleButton.disabled = false;
    toggleButton.textContent = "Press Me";
  };
}

function speechRecognition() {
  // initializes the speech recognition for the very first time
  if (!recognition) {
    initializeSpeechRecognition();
  }
  // starting the recognition
  recognition.start();
}

function getReplyFromAI(data) {
  // fetches the result from GPT
  fetch("/reply", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: encodeURIComponent(data),
  })
    .then((res) => res.text())
    .then((data) => {
      // displays the response generated by AI
      document.getElementById("result_ai").textContent = data;
      // speaks the response generated by GPT
      speech.text = data;
      window.speechSynthesis.speak(speech);
    })
    .catch((err) => {
      console.log(err);
    });
}

const toggleButton = document.getElementById("toggleButton");
toggleButton.addEventListener("click", speechRecognition);
